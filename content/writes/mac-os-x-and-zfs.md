---
title: "Mac OS X and ZFS"
date: 2007-10-31 13:49:52
type: post
---

<p>So, I'm running the ZFS beta seed on Mac OS X.</p>  <p>It's a beta, but in my opinion, beta in filesystems are solid.  This isn't... yet.  First off, I've had about 20 panicks in the last 8 hours of running it.  Not good.  This alone means it is alpha to me.  The beta aspects of it don't bother me so much and I see its potential.</p>  <h3>Basic setup</h3>  I resized my internal 160GB boo drive to 100 and 60. (60 being blank). <pre> /usr/sbin/zpool create internal disk0s3 /usr/sbin/zfs create internal/homes /usr/sbin/zfs create internal/homes/jesus /usr/sbin/zfs create internal/homes/jesus/src /usr/sbin/zfs create internal/homes/jesus/Documents /usr/sbin/zfs create internal/homes/jesus/Library rsync -av ~jesus/src/ /Volumes/internal/homes/jesus/src/ rsync -av ~jesus/Documents/ /Volumes/internal/homes/jesus/Documents/ rsync -av ~jesus/Library/ /Volumes/internal/homes/jesus/Library/ ### [*** BOOM ***] ### (again and again and again -- sent many reports to Apple) /usr/sbin/zfs destroy internal/homes/jesus/Library rm -rf /Users/jesus/src rm -rf /Users/jesus/Documents /usr/sbin/zfs set mountpoint=/Users/jesus/src internal/homes/jesus/src /usr/sbin/zfs set mountpoint=/Users/jesus/Documents internal/homes/jesus/Documents </pre>  <h3>Problems from the get-go</h3>  <p>The zpool worked and the creation of the homes FS worked.  The others created, but didn't mount.  I had to run <b>zfs mount</b> manually to get them to work.  Notably, on next reboot (after an import glitch) they all auto-mount fine.</p>  <p>The flurry of panicks during my attempts to sync my ~/Library/ was disappointing.  No data loss occurred and no corruption happened.  So, it was the "best kind" of panick (if there is such a thing).  My src and Documents is about 9GB and that copied over without any issues.  Anyway, it should be obvious that I backed everything up before I started.</p>  <h3>Boot up / Shutdown</h3>  <p>First, there is no bootup integration to see previously imported zpools.  Also, when I try to import the zpool it thinks it is from a different system and I have to use -f... very odd.  Anyway, my zpool is call "internal," so I create a StartupItems dir called ZFS and had it <b>/usr/sbin/zpool import -f internal</b> on boot and <b>/usr/sbin/zpool export internal</b> on shutdown.  Of course, normally we wouldn't export the pool on shutdown, but as it thinks it is owned by someone else when I boot next, I thought it safer that way.</p>  <h3>Backups</h3>  <p>One of the reasons I wanted ZFS is that snapshot capabilities.  In addition to snapshots proper, <b>zfs send</b> allows one to push a full (or incremental) snapshot to a stream.  <a href="https://labs.omniti.com/trac/zetaback">Zetaback</a> is a sweet tool to do automatic network-based backups of ZFS volumes.  It is very efficient and quite exploratory in nature.  However, <b>zfs send</b> just produces: <b>internal error: Bad file descriptor</b> which means "unimlemented."  A beta-ism -- at least it didn' panick.</p>  <h3>Metadata</h3>  <p>One of the shining points (arguably) of Mac OS X is Spotlight.  And while you might not use Spotlight directly, you likely use it indirectly.  Mac OS X manages these on a per-volume basis and something in ZFS confuses it substantially.</p>  <pre> # mdutil -s / /: \tIndexing enabled. # mdutil -s /Volumes/internal /Volumes/internal: \tIndexing enabled. # mdutil -s /Volumes/internal/homes /Volumes/internal/homes: \tIndexing and searching disabled. # mdutil -v -i on /Volumes/internal/homes /Volumes/internal/homes: \tIndexing and searching disabled. </pre>  <p>As you can see, you cannot enable metadata indexing and searching on zfs filesystems within a pool.  This (to me) sounds like a simple fix, but still it makes moving my Documents to ZFS unappealing.</p>  <h3>Summary</h3>  <p>I'm excited to see where this is going.  I sure do like ZFS on Solaris.  I'd like to see Mac OS X with tight integration.  I don't care so much about the system disk being ZFS (though it would be nice), it's the user directories that could really make it shine.</p>
